# 配置系统使用说明

## 概述

系统已经完成重构，现在支持用户在网页界面上自定义模型的提示词和RAG知识库设置。不再有硬编码的"医疗诊断模型"，所有配置都可以灵活调整。

## 主要功能

### 1. 动态配置管理

系统引入了 `ConfigManager` 配置管理器，用于：
- 保存和加载用户配置
- 管理提示词模板
- 控制RAG知识库的启用/禁用
- 自定义系统名称和欢迎消息

配置文件保存在：`./data/user_config.json`

### 2. 可配置的提示词

所有Agent的提示词都可以在配置界面中自定义：

#### Agent决策提示词
用于决定使用哪个Agent来处理用户的查询

#### 对话Agent提示词
用于一般性对话的提示词模板

#### RAG Agent提示词
用于基于知识库检索的回答

#### 网络搜索Agent提示词
用于基于网络搜索结果的回答

### 3. RAG知识库开关

可以在配置界面中启用或禁用RAG知识库：
- **启用**：系统会使用知识库进行检索增强生成
- **禁用**：系统不会调用RAG Agent，相关查询会转给对话Agent处理

### 4. 自定义系统信息

- **系统名称**：自定义系统显示的名称
- **欢迎消息**：自定义首次打开系统时的欢迎语

## 使用指南

### 访问配置界面

1. 启动系统：`python app.py`
2. 打开浏览器访问：`http://localhost:8000`
3. 点击页面顶部的 **⚙️ 配置** 标签

### 修改配置

1. 在配置页面中修改相应的字段
2. 点击 **💾 保存配置** 按钮
3. 系统会立即应用新配置，无需重启

### 重置配置

如果需要恢复到默认配置：
1. 点击 **🔄 重置为默认** 按钮
2. 确认操作
3. 系统会恢复到初始配置

## API接口

系统提供了以下配置相关的API接口：

### 获取配置
```http
GET /config
```

返回当前系统配置

### 更新配置
```http
POST /config
Content-Type: application/json

{
  "system_name": "我的智能助手",
  "welcome_message": "欢迎使用！",
  "rag_enabled": true,
  "agent_decision_prompt": "...",
  "conversation_prompt": "...",
  "rag_prompt": "...",
  "websearch_prompt": "..."
}
```

### 重置配置
```http
POST /config/reset
```

重置配置为默认值

## 配置文件结构

配置文件 `./data/user_config.json` 包含以下字段：

```json
{
  "rag_enabled": true,
  "agent_decision_prompt": "...",
  "conversation_prompt": "...",
  "rag_prompt": "...",
  "websearch_prompt": "...",
  "system_name": "智能Agent系统",
  "welcome_message": "您好!我是您的智能助手...",
  "updated_at": "2025-10-19T..."
}
```

## 提示词模板变量

在编写提示词时，可以使用以下变量（会被系统自动替换）：

### Agent决策提示词
- `{conversation_history}` - 对话历史
- `{query}` - 用户查询

### 对话Agent提示词
- `{conversation_history}` - 对话历史
- `{query}` - 用户查询

### RAG Agent提示词
- `{context}` - 检索到的知识库内容
- `{conversation_history}` - 对话历史
- `{query}` - 用户查询

### 网络搜索Agent提示词
- `{search_results}` - 搜索结果
- `{conversation_history}` - 对话历史
- `{query}` - 用户查询

## 注意事项

1. **提示词格式**：提示词中必须包含相应的变量占位符（如`{query}`），否则系统可能无法正常工作

2. **RAG禁用**：如果禁用RAG，所有需要知识库的查询会自动转给对话Agent处理

3. **配置持久化**：所有配置更改会立即保存到文件，重启系统后配置仍然有效

4. **备份建议**：建议定期备份 `./data/user_config.json` 文件

## 测试系统

运行测试脚本验证系统功能：

```bash
python test_system.py
```

测试内容包括：
- 配置管理器功能
- 各个Agent初始化
- 提示词更新机制
- RAG开关功能

## 故障排除

### 配置未生效
1. 检查 `./data/user_config.json` 是否存在
2. 确认修改后点击了"保存配置"按钮
3. 检查浏览器控制台是否有错误信息

### RAG不工作
1. 确认RAG已启用（勾选了"启用RAG知识库"）
2. 检查知识库是否有数据（运行 `python ingest_data.py` 导入数据）
3. 查看终端日志是否有错误信息

### 提示词格式错误
1. 确保提示词包含必需的变量占位符
2. 使用"重置为默认"功能查看正确的格式
3. 参考本文档的"提示词模板变量"部分

## 技术架构

### 配置管理流程
```
用户修改配置 → 前端发送API请求 → 后端更新配置文件 → 
更新各Agent提示词 → 立即生效
```

### Agent初始化流程
```
系统启动 → 加载ConfigManager → 初始化各Agent → 
传入ConfigManager → Agent加载配置的提示词
```

### RAG开关逻辑
```
用户查询 → Agent决策 → 如果决策为RAG且RAG已禁用 → 
转为使用对话Agent → 返回结果
```

## 更新日志

### v2.0.0 (2025-10-19)
- ✅ 完全移除硬编码的"医疗诊断模型"
- ✅ 添加配置管理系统
- ✅ 实现动态提示词更新
- ✅ 添加RAG知识库开关
- ✅ 创建配置界面
- ✅ 添加配置API接口
- ✅ 通过所有系统测试

## 联系支持

如有问题或建议，请查看项目文档或联系开发团队。

