# 系统重构变更说明

## 重构目标

解决用户反馈的问题：无法自定义模型和默认提示词，"医疗诊断模型"被硬编码进代码。

## 主要变更

### 1. 新增配置管理模块 (`config_manager.py`)

**功能**：
- 统一管理所有系统配置
- 支持配置的保存和加载
- 提供默认配置和重置功能
- 配置持久化到 `./data/user_config.json`

**主要方法**：
- `load_config()`: 加载配置
- `save_config()`: 保存配置
- `update_config()`: 更新配置
- `reset_to_default()`: 重置为默认配置
- `is_rag_enabled()`: 检查RAG是否启用
- `get_prompt()`: 获取指定类型的提示词

### 2. 重构所有Agent类

#### AgentDecision (`agents/agent_decision.py`)
**变更**：
- 构造函数接收 `config_manager` 参数
- 添加 `update_prompt()` 方法，支持动态更新提示词
- 添加 `_get_default_template()` 方法，提供默认模板
- 移除硬编码的医疗相关描述，使用通用描述

#### ConversationAgent (`agents/conversation_agent.py`)
**变更**：
- 构造函数接收 `config_manager` 参数
- 添加 `update_prompt()` 方法
- 添加 `_get_default_template()` 方法
- 移除硬编码的"医疗咨询助手"描述
- 动态使用系统配置的名称

#### MedicalRAG (`agents/rag_agent/__init__.py`)
**变更**：
- 构造函数接收 `config_manager` 参数
- 添加 `update_prompt()` 方法
- 添加 `_get_default_template()` 方法
- 移除医疗专业术语，使用通用描述

#### WebSearchAgent (`agents/web_search_agent/__init__.py`)
**变更**：
- 构造函数接收 `config_manager` 参数
- 添加 `update_prompt()` 方法
- 添加 `_get_default_template()` 方法
- 移除医疗关键词的自动添加
- 动态使用系统配置的名称

### 3. 重构主应用 (`app.py`)

#### 后端变更
**新增**：
- 导入 `ConfigManager`
- 初始化配置管理器
- 所有Agent初始化时传入 `config_manager`
- 新增 `ConfigRequest` 模型类
- 新增配置相关API端点：
  - `GET /config`: 获取当前配置
  - `POST /config`: 更新配置
  - `POST /config/reset`: 重置配置
- 在chat处理中添加RAG开关逻辑

#### 前端变更
**新增**：
- 标签页导航（对话/配置）
- 配置页面UI
- 配置表单（系统名称、欢迎消息、RAG开关、各Agent提示词）
- 配置保存和重置功能
- 配置加载和显示功能
- 成功消息提示

**优化**：
- 更新标题为"智能Agent系统"
- 欢迎消息动态加载
- 响应式布局优化

### 4. 新增测试脚本 (`test_system.py`)

**测试内容**：
- 配置管理器功能测试
- 各Agent初始化测试
- 提示词更新机制测试
- RAG开关功能测试

### 5. 新增文档

- `docs/配置系统使用说明.md`: 详细的配置系统使用指南
- `docs/重构变更说明.md`: 本文档
- 更新 `README.md`: 添加新功能说明

## 配置文件结构

`./data/user_config.json`:
```json
{
  "rag_enabled": true,
  "agent_decision_prompt": "...",
  "conversation_prompt": "...",
  "rag_prompt": "...",
  "websearch_prompt": "...",
  "system_name": "智能Agent系统",
  "welcome_message": "...",
  "updated_at": "2025-10-19T..."
}
```

## API变更

### 新增端点

#### GET /config
获取当前配置

**响应**：
```json
{
  "success": true,
  "config": {...}
}
```

#### POST /config
更新配置

**请求体**：
```json
{
  "system_name": "...",
  "welcome_message": "...",
  "rag_enabled": true,
  "agent_decision_prompt": "...",
  "conversation_prompt": "...",
  "rag_prompt": "...",
  "websearch_prompt": "..."
}
```

**响应**：
```json
{
  "success": true,
  "message": "配置更新成功"
}
```

#### POST /config/reset
重置配置为默认值

**响应**：
```json
{
  "success": true,
  "message": "配置已重置为默认值"
}
```

## 向后兼容性

### 兼容处理
- 如果 `user_config.json` 不存在，会自动创建默认配置
- 所有Agent都提供默认模板，即使没有配置管理器也能运行
- 旧的环境变量配置仍然有效

### 不兼容的变更
- ❌ 硬编码的医疗相关描述已移除
- ❌ 需要手动重新配置提示词以适应新场景

## 测试结果

运行 `python test_system.py` 的测试结果：

```
✅ 通过 - 配置管理器
✅ 通过 - Agent系统
✅ 通过 - 提示词更新
✅ 通过 - RAG开关
```

所有测试通过！

## 文件变更清单

### 新增文件
- `config_manager.py`: 配置管理器
- `test_system.py`: 系统测试脚本
- `docs/配置系统使用说明.md`: 使用文档
- `docs/重构变更说明.md`: 变更说明
- `./data/user_config.json`: 配置文件（自动生成）

### 修改文件
- `app.py`: 重构前端和后端
- `agents/agent_decision.py`: 添加配置支持
- `agents/conversation_agent.py`: 添加配置支持
- `agents/rag_agent/__init__.py`: 添加配置支持
- `agents/web_search_agent/__init__.py`: 添加配置支持
- `README.md`: 更新文档

### 未修改文件
- `config.py`: 保持原有的基础配置
- `ingest_data.py`: 数据导入脚本
- 其他文档文件

## 使用建议

### 首次使用
1. 启动系统后会自动生成默认配置
2. 访问配置页面，根据需求修改提示词
3. 设置系统名称和欢迎消息
4. 保存配置

### 提示词编写
1. 保持必需的变量占位符（如 `{query}`, `{conversation_history}`）
2. 根据实际使用场景调整提示词内容
3. 可以参考默认模板作为起点
4. 建议先小范围测试，确认效果后再大规模使用

### RAG管理
1. 如果没有知识库数据，建议禁用RAG
2. 如果只需要对话功能，可以禁用RAG以提高响应速度
3. 知识库内容变化后，提示词可能需要相应调整

## 后续优化建议

1. **多配置方案**：支持保存和切换多套配置
2. **配置导入导出**：支持配置文件的导入和导出
3. **在线编辑器**：提供更好的提示词编辑体验
4. **配置版本控制**：记录配置变更历史
5. **配置模板库**：提供不同场景的配置模板
6. **权限管理**：添加配置修改权限控制

## 总结

本次重构彻底解决了硬编码问题，系统现在完全可配置。用户可以：
- ✅ 在网页上自定义所有提示词
- ✅ 启用或禁用RAG知识库
- ✅ 自定义系统名称和欢迎消息
- ✅ 配置持久化，重启后仍然有效
- ✅ 随时重置为默认配置

系统现在更加灵活，可以适应各种不同的应用场景，不再局限于医疗领域。

